{
    "version": "https://jsonfeed.org/version/1",
    "title": "Oikiou's Blog • All posts by \"wiringpi\" tag",
    "description": "Blog",
    "home_page_url": "https://www.oikiou.top",
    "items": [
        {
            "id": "https://www.oikiou.top/2021/b0f7a103/",
            "url": "https://www.oikiou.top/2021/b0f7a103/",
            "title": "树莓派4B PWM温控风扇 Wiringpi库 PWM调整频率 54M PWM频率不对",
            "date_published": "2021-08-02T15:23:05.000Z",
            "content_html": "<p>关键词:<br>树莓派4B PWM温控风扇 wiringpi库 PWM调整频率 54M PWM频率不对</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>很多博客文章都是说树莓派PWM是按<strong>19.2M</strong>基频率来算的，今天用逻辑分析仪抓了一下波形后发现频率有问题，然后按测得的频率反推，算出来我这里好像是按<strong>54M</strong>的时钟频率来的，不清楚是什么情况。我这里的环境是<code>wiringpi=2.52</code> + <code>树莓派4B</code> + <code>Linux raspberrypi 5.10.52-v7l+ #1440 SMP Tue Jul 27 09:55:21 BST 2021 armv7l GNU/Linux</code></p>\n<p><a href=\"https://www.cnblogs.com/miaoxiong/p/10556072.html\">PWM 19.2M时钟的原文</a> <a href=\"https://www.cnblogs.com/miaoxiong/p/10556072.html\">https://www.cnblogs.com/miaoxiong/p/10556072.html</a></p>\n<h1 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h1><p>思路就是读取cpu温度的文件，根据不同温度来控制PWM控制风扇转停，这个编译下来跑起来<code>htop</code>看cpu占用一直等于0，对比原来python写的温控风扇2% 3%的cpu占用在跳，没想到差距这么大。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;stdio.h&gt;</span></span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;stdlib.h&gt;</span></span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;stdint.h&gt;</span></span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;wiringPi.h&gt;</span></span><br><br><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> FAN_PIN         1</span><br><span class=\"hljs-comment\">// Hz</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> PWM_FRQ         (200ul)</span><br><span class=\"hljs-comment\">// frq = 54M / PWM_RANG / divisor</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> PWM_RANG        (100ul)</span><br><span class=\"hljs-comment\">// temperature</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> TEMP_PATH <span class=\"hljs-string\">&quot;/sys/class/thermal/thermal_zone0/temp&quot;</span></span><br><span class=\"hljs-comment\">//</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> BUFF_MAX_SIZE   32u</span><br><br><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">if</span> 0</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> DBG_LOG(format, ...)      do&#123; printf(format, ##__VA_ARGS__ ); &#125;while(0)</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">else</span></span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> DBG_LOG(format, ...)</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">endif</span></span><br><br><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">GetTemperature</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> *temp)</span>;<br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">GetDuty</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> temp)</span>;<br><br><br><span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">int</span> Duty = <span class=\"hljs-number\">0</span>;<br>FILE *pFile = <span class=\"hljs-literal\">NULL</span>;<br><span class=\"hljs-type\">char</span> buff[BUFF_MAX_SIZE] = &#123;<span class=\"hljs-number\">0</span>&#125;;<br><span class=\"hljs-type\">float</span> fTemperature = <span class=\"hljs-number\">0</span>;<br><span class=\"hljs-type\">int</span> Temperature = <span class=\"hljs-number\">0</span>;<br><br><br><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">void</span>)</span><br>&#123;<br>    DBG_LOG(<span class=\"hljs-string\">&quot;Raspberry Pi wiringPi PWM test program\\n&quot;</span>);<br>    <span class=\"hljs-keyword\">if</span> (wiringPiSetup() == <span class=\"hljs-number\">-1</span>)<br>    &#123;<br>        DBG_LOG(<span class=\"hljs-string\">&quot;GPIO setup error!\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">2</span>);<br>    &#125;<br>    pinMode(FAN_PIN, PWM_OUTPUT);<br>    pwmSetMode(PWM_MODE_MS);<br>    pwmSetRange(PWM_RANG);                       <span class=\"hljs-comment\">//base frq 54M</span><br>    pwmSetClock(<span class=\"hljs-number\">54000000</span>/PWM_RANG/PWM_FRQ);<br>    pwmWrite(FAN_PIN, <span class=\"hljs-number\">0</span>);<br><br>    <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-number\">1</span>)<br>    &#123;<br>        GetTemperature(&amp;Temperature);<br>        Duty = GetDuty(Temperature);<br><br>        pwmWrite(FAN_PIN, Duty);<br>        DBG_LOG(<span class=\"hljs-string\">&quot;Temp=%d Duty=%d\\n&quot;</span>, Temperature, Duty);<br>        delay(<span class=\"hljs-number\">1000</span>*<span class=\"hljs-number\">10</span>);<br>    &#125;<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">GetTemperature</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> *temp)</span><br>&#123;<br>    pFile = fopen(TEMP_PATH, <span class=\"hljs-string\">&quot;r&quot;</span>);<br>    <span class=\"hljs-keyword\">if</span>(pFile == <span class=\"hljs-literal\">NULL</span>)<br>    &#123;<br>        DBG_LOG(<span class=\"hljs-string\">&quot;file can&#x27;t open PATH=%s p=%p\\n&quot;</span>, TEMP_PATH, pFile);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    fgets(buff, BUFF_MAX_SIZE, pFile);<br>    *temp = (<span class=\"hljs-type\">int</span>)(atoi(buff)/<span class=\"hljs-number\">1000.0</span>+<span class=\"hljs-number\">0.5</span>);<br>    fclose(pFile);<br>&#125;<br><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">GetDuty</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> temp)</span><br>&#123;<br>    <span class=\"hljs-keyword\">if</span>(temp &gt;= <span class=\"hljs-number\">60</span>)<br>    &#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">100</span>;<br>    &#125;<br>    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(temp &gt;= <span class=\"hljs-number\">55</span>)<br>    &#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">80</span>;<br>    &#125;<br>    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(temp &gt;= <span class=\"hljs-number\">53</span>)<br>    &#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">70</span>;<br>    &#125;<br>    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(temp &gt;= <span class=\"hljs-number\">50</span>)<br>    &#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">60</span>;<br>    &#125;<br>    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(temp &gt;= <span class=\"hljs-number\">49</span>)<br>    &#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">50</span>;<br>    &#125;<br>    <span class=\"hljs-keyword\">else</span><br>    &#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>最后编译一下<br><code>gcc -Wall -O -o fan fan.c   -lwiringPi </code></p>\n<p>再加个开机启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">sudo nano /etc/rc.local<br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">在文件<span class=\"hljs-built_in\">exit</span>前加上 fan程序</span><br>sudo ./path/fan &amp;<br></code></pre></td></tr></table></figure>\n<p>这个温度控制不是很好，转转停停的(<em>估计是PWM值太小风扇转的不好, 尝试加电容电感应该会好些</em>)</p>\n",
            "tags": [
                "raspberry",
                "wiringpi",
                "pwm"
            ]
        },
        {
            "id": "https://www.oikiou.top/2021/d8eac117/",
            "url": "https://www.oikiou.top/2021/d8eac117/",
            "title": "树莓派4B GPIO库 Wiringpi Oops -  Unable to Determine Board Type",
            "date_published": "2021-08-02T15:23:05.000Z",
            "content_html": "<p>关键词:<br>树莓派4B GPIO库 wiringpi Oops - unable to determine board type… model_ 17</p>\n<h1 id=\"先说解决方案\"><a href=\"#先说解决方案\" class=\"headerlink\" title=\"先说解决方案\"></a>先说解决方案</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">cd /tmp<br>wget https://project-downloads.drogon.net/wiringpi-latest.deb<br>sudo dpkg -i wiringpi-latest.deb<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"问题描述\"><a href=\"#问题描述\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h1><p><a href=\"http://wiringpi.com/wiringpi-updated-to-2-52-for-the-raspberry-pi-4b/\">官网给的解释</a> <a href=\"http://wiringpi.com/wiringpi-updated-to-2-52-for-the-raspberry-pi-4b/\">http://wiringpi.com/wiringpi-updated-to-2-52-for-the-raspberry-pi-4b/</a></p>\n<p>树莓派4B 用wiringpi这个GPIO库的时候无法正常使用，我是在用作树莓派pwm风扇调速的时候发现一直输出不了pwm，示波器抓波形发现也不对，检查原因的时候发现 <code>gpio readall</code>输出报错，最后官方文档说到<strong>树莓派4B</strong>需要保证<strong>2.52版本</strong>及以上才能适配(<code>gpio -v</code>查看版本)，apt直接安装的似乎还没更新最新版本只到2.50，不太清楚为什么一年了这源都还没更新</p>\n",
            "tags": [
                "raspberry",
                "wiringpi"
            ]
        }
    ]
}